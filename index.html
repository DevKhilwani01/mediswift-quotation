<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mediswift Quotation Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      padding: 16px 20px 24px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.08);
    }
    h1 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .fx-credit {
      text-align: center;
      font-size: 10px;
      color: #777;
      margin-bottom: 16px;
    }
    .fx-credit a {
      color: #555;
      text-decoration: none;
    }
    .section-title {
      margin-top: 15px;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 14px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 3px;
    }
    label {
      font-size: 12px;
      font-weight: bold;
      display: block;
      margin-bottom: 2px;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 6px;
      font-size: 13px;
      margin-bottom: 6px;
    }
    textarea {
      min-height: 220px;
      white-space: pre-wrap;
    }
    .row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 8px;
    }
    .row-8 {
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .small-note {
      font-size: 11px;
      color: #555;
      margin-bottom: 8px;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    button {
      width: auto;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f0f0f0;
    }
    button.primary {
      background: #007bff;
      border-color: #007bff;
      color: #fff;
    }
    button.danger {
      background: #dc3545;
      border-color: #dc3545;
      color: #fff;
    }
    button.secondary {
      background: #6c757d;
      border-color: #6c757d;
      color: #fff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .product-card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #fafafa;
    }
    .product-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .product-card-title {
      font-weight: bold;
      font-size: 13px;
    }
    .product-card-lines {
      font-size: 12px;
      white-space: pre-wrap;
      margin-bottom: 4px;
    }
    .product-card-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    @media (max-width: 900px) {
      .row-8 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    @media (max-width: 600px) {
      .row-8 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Mediswift Quotation Generator</h1>
    <div class="subtitle">
      Select preset from Google Sheet → adjust → <b>Add Product to Quote</b> / <b>Save Product to Sheet</b>.
    </div>
    <div class="fx-credit">
      Rates by <a href="https://currencyfreaks.com" target="_blank" rel="noopener noreferrer">CurrencyFreaks</a>
    </div>

    <!-- PRODUCT FORM -->
    <div class="section-title">Product Details</div>

    <label for="product_preset">Select Product Preset (from Google Sheet)</label>
    <select id="product_preset" onchange="onPresetChange()">
      <option value="">Loading...</option>
    </select>
    <div class="small-note">
      Product presets are loaded from your Google Sheet (tab: <b>Products</b>).
    </div>

    <div class="row-3">
      <div>
        <label for="prod_name">Product Name</label>
        <input id="prod_name" />
      </div>
      <div>
        <label for="prod_power">Power</label>
        <input id="prod_power" />
      </div>
      <div>
        <label for="prod_form">Dosage Form</label>
        <select id="prod_form">
          <option>Tablets</option>
          <option>Capsules</option>
          <option>Injection</option>
          <option>Tube</option>
          <option>Inhaler</option>
          <option>Cream</option>
          <option>Gel</option>
        </select>
      </div>
    </div>

    <!-- Brand / Composition / Alt Currency -->
    <div class="row-3">
      <div>
        <label style="font-weight: normal;">
          <input type="checkbox" id="enable_brand" onchange="toggleBrand()" />
          Include Brand Name
        </label>
        <input id="prod_brand" style="display:none;" />
      </div>
      <div>
        <label style="font-weight: normal;">
          <input type="checkbox" id="enable_comp" onchange="toggleComp()" />
          Include Composition
        </label>
        <input id="prod_comp" style="display:none;" />
      </div>
      <div>
        <label style="font-weight: normal;">Alt Currency</label>
        <label style="font-weight: normal;">
          <input type="checkbox" id="enable_alt" checked onchange="updateAltVisibility()" />
          Enable Alt Currency (show & convert)
        </label>
      </div>
    </div>

    <!-- Line 1 -->
    <div class="small-note"><b>Line 1</b></div>
    <div class="row-8">
      <div>
        <label for="l1_qty">Qty</label>
        <input id="l1_qty" />
      </div>
      <div>
        <label for="l1_unit">Unit</label>
        <select id="l1_unit">
          <option>blister</option>
          <option>box</option>
          <option>packs</option>
          <option>strip</option>
        </select>
      </div>
      <div>
        <label for="l1_pillsqty">Pills Qty</label>
        <input id="l1_pillsqty" />
      </div>
      <div>
        <label for="l1_pillsunit">Pills Unit</label>
        <select id="l1_pillsunit">
          <option>ampouls</option>
          <option>capsule</option>
          <option>injection</option>
          <option>pills</option>
          <option>sachets</option>
          <option>tube</option>
          <option>vial</option>
        </select>
      </div>
      <div>
        <label for="l1_priceamt">Price Amt</label>
        <input id="l1_priceamt" oninput="onMainPriceChange('l1')" />
      </div>
      <div>
        <label for="l1_pricecur">Currency</label>
        <select id="l1_pricecur" onchange="onMainPriceChange('l1')">
          <option>AED</option>
          <option>AUD</option>
          <option>BHD</option>
          <option>CAD</option>
          <option>CHF</option>
          <option>CNY</option>
          <option>EUR</option>
          <option>GBP</option>
          <option>HKD</option>
          <option>JPY</option>
          <option>KWD</option>
          <option>NZD</option>
          <option>QAR</option>
          <option>SAR</option>
          <option>SGD</option>
          <option>USD</option>
          <option>ZAR</option>
        </select>
      </div>
      <div class="alt-field">
        <label for="l1_altcur">Alt Currency</label>
        <select id="l1_altcur" onchange="onAltCurrencyChange('l1')">
          <option></option>
          <option>AED</option>
          <option>AUD</option>
          <option>BHD</option>
          <option>CAD</option>
          <option>CHF</option>
          <option>CNY</option>
          <option>EUR</option>
          <option>GBP</option>
          <option>HKD</option>
          <option>JPY</option>
          <option>KWD</option>
          <option>NZD</option>
          <option>QAR</option>
          <option>SAR</option>
          <option>SGD</option>
          <option>USD</option>
          <option>ZAR</option>
        </select>
      </div>
      <div class="alt-field">
        <label for="l1_altamt">Alt Amt</label>
        <input id="l1_altamt" />
      </div>
    </div>

    <!-- Line 2 -->
    <div class="small-note"><b>Line 2</b></div>
    <div class="row-8">
      <div>
        <label for="l2_qty">Qty</label>
        <input id="l2_qty" />
      </div>
      <div>
        <label for="l2_unit">Unit</label>
        <select id="l2_unit">
          <option>blister</option>
          <option>box</option>
          <option>packs</option>
          <option>strip</option>
        </select>
      </div>
      <div>
        <label for="l2_pillsqty">Pills Qty</label>
        <input id="l2_pillsqty" />
      </div>
      <div>
        <label for="l2_pillsunit">Pills Unit</label>
        <select id="l2_pillsunit">
          <option>ampouls</option>
          <option>capsule</option>
          <option>injection</option>
          <option>pills</option>
          <option>sachets</option>
          <option>tube</option>
          <option>vial</option>
        </select>
      </div>
      <div>
        <label for="l2_priceamt">Price Amt</label>
        <input id="l2_priceamt" oninput="onMainPriceChange('l2')" />
      </div>
      <div>
        <label for="l2_pricecur">Currency</label>
        <select id="l2_pricecur" onchange="onMainPriceChange('l2')">
          <option>AED</option>
          <option>AUD</option>
          <option>BHD</option>
          <option>CAD</option>
          <option>CHF</option>
          <option>CNY</option>
          <option>EUR</option>
          <option>GBP</option>
          <option>HKD</option>
          <option>JPY</option>
          <option>KWD</option>
          <option>NZD</option>
          <option>QAR</option>
          <option>SAR</option>
          <option>SGD</option>
          <option>USD</option>
          <option>ZAR</option>
        </select>
      </div>
      <div class="alt-field">
        <label for="l2_altcur">Alt Currency</label>
        <select id="l2_altcur" onchange="onAltCurrencyChange('l2')">
          <option></option>
          <option>AED</option>
          <option>AUD</option>
          <option>BHD</option>
          <option>CAD</option>
          <option>CHF</option>
          <option>CNY</option>
          <option>EUR</option>
          <option>GBP</option>
          <option>HKD</option>
          <option>JPY</option>
          <option>KWD</option>
          <option>NZD</option>
          <option>QAR</option>
          <option>SAR</option>
          <option>SGD</option>
          <option>USD</option>
          <option>ZAR</option>
        </select>
      </div>
      <div class="alt-field">
        <label for="l2_altamt">Alt Amt</label>
        <input id="l2_altamt" />
      </div>
    </div>

    <!-- Line 3 -->
    <div class="small-note"><b>Line 3</b></div>
    <div class="row-8">
      <div>
        <label for="l3_qty">Qty</label>
        <input id="l3_qty" />
      </div>
      <div>
        <label for="l3_unit">Unit</label>
        <select id="l3_unit">
          <option>blister</option>
          <option>box</option>
          <option>packs</option>
          <option>strip</option>
        </select>
      </div>
      <div>
        <label for="l3_pillsqty">Pills Qty</label>
        <input id="l3_pillsqty" />
      </div>
      <div>
        <label for="l3_pillsunit">Pills Unit</label>
        <select id="l3_pillsunit">
          <option>ampouls</option>
          <option>capsule</option>
          <option>injection</option>
          <option>pills</option>
          <option>sachets</option>
          <option>tube</option>
          <option>vial</option>
        </select>
      </div>
      <div>
        <label for="l3_priceamt">Price Amt</label>
        <input id="l3_priceamt" oninput="onMainPriceChange('l3')" />
      </div>
      <div>
        <label for="l3_pricecur">Currency</label>
        <select id="l3_pricecur" onchange="onMainPriceChange('l3')">
          <option>AED</option>
          <option>AUD</option>
          <option>BHD</option>
          <option>CAD</option>
          <option>CHF</option>
          <option>CNY</option>
          <option>EUR</option>
          <option>GBP</option>
          <option>HKD</option>
          <option>JPY</option>
          <option>KWD</option>
          <option>NZD</option>
          <option>QAR</option>
          <option>SAR</option>
          <option>SGD</option>
          <option>USD</option>
          <option>ZAR</option>
        </select>
      </div>
      <div class="alt-field">
        <label for="l3_altcur">Alt Currency</label>
        <select id="l3_altcur" onchange="onAltCurrencyChange('l3')">
          <option></option>
          <option>AED</option>
          <option>AUD</option>
          <option>BHD</option>
          <option>CAD</option>
          <option>CHF</option>
          <option>CNY</option>
          <option>EUR</option>
          <option>GBP</option>
          <option>HKD</option>
          <option>JPY</option>
          <option>KWD</option>
          <option>NZD</option>
          <option>QAR</option>
          <option>SAR</option>
          <option>SGD</option>
          <option>USD</option>
          <option>ZAR</option>
        </select>
      </div>
      <div class="alt-field">
        <label for="l3_altamt">Alt Amt</label>
        <input id="l3_altamt" />
      </div>
    </div>

    <div class="buttons">
      <button class="primary" type="button" onclick="addProductToQuote()">Add Product to Quote</button>
      <button type="button" onclick="saveProductToSheet()">Save Product to Sheet</button>
      <button class="secondary" type="button" onclick="clearProductForm()">Clear Form</button>
    </div>

    <!-- PRODUCTS ADDED -->
    <div class="section-title">Products in this Quotation</div>
    <div id="quoteProducts" class="small-note">
      No products added yet. Fill the form above and click “Add Product to Quote”.
    </div>

    <!-- GENERATE -->
    <div class="section-title">Generated Quotation</div>
    <div class="buttons">
      <button class="primary" type="button" onclick="generateQuotation()">Generate Quotation</button>
      <button type="button" onclick="copyOutput()">Copy to Clipboard</button>
      <button class="secondary" type="button" onclick="clearQuotation()">Clear Quotation</button>
    </div>
    <textarea id="output" readonly></textarea>
  </div>

  <script>
    // Google Apps Script Web App URL
    const PRODUCTS_API_URL = "https://script.google.com/macros/s/AKfycbwu0gU8YXxDueXl7HpdyNnwZYXIxz0EmGdxvihBqInlRTY9vulKwEozkAB2vRrsLcjtLg/exec";

    // CurrencyFreaks API key (yours)
    const FX_API_KEY = "0979bb8cef154310a0d57817aa5d3080";

    // Default base rates (1 USD = X currency)
    const FX_RATES_DEFAULT = {
      AED: 3.67135,
      AUD: 1.50644,
      BHD: 0.376888,
      CAD: 1.38498,
      CHF: 0.803285,
      CNY: 7.06359,
      EUR: 0.859298,
      GBP: 0.750249,
      HKD: 7.78111,
      JPY: 156.56,
      KWD: 0.307062,
      NZD: 1.72997,
      QAR: 3.64725,
      SAR: 3.75324,
      SGD: 1.29587,
      USD: 1,
      ZAR: 17.0017
    };

    let ONLINE_PRODUCTS = [];
    let QUOTE_PRODUCTS = [];

    // FX rate cache
    let FX_RATES = { ...FX_RATES_DEFAULT };
    const FX_CACHE_TTL_MS = 4 * 60 * 60 * 1000; // 4 hours
    let FX_ERROR_SHOWN = false;

    // Load FX rates with localStorage caching + CurrencyFreaks refresh
    async function loadFxRates() {
      try {
        const storedRaw = localStorage.getItem("mediswift_fx_rates");
        if (storedRaw) {
          const stored = JSON.parse(storedRaw);
          if (stored && stored.rates) {
            FX_RATES = stored.rates;
            const ts = stored.timestamp || 0;
            const age = Date.now() - ts;
            if (age < FX_CACHE_TTL_MS) {
              return;
            }
          }
        }
      } catch (e) {
        console.warn("localStorage read error", e);
      }

      const url = "https://api.currencyfreaks.com/v1/latest?apikey=" + encodeURIComponent(FX_API_KEY);
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.rates) {
          FX_RATES = data.rates;
          try {
            localStorage.setItem("mediswift_fx_rates", JSON.stringify({
              rates: FX_RATES,
              timestamp: Date.now()
            }));
          } catch (e) {
            console.warn("localStorage write error", e);
          }
        } else {
          console.error("FX API response invalid", data);
        }
      } catch (e) {
        console.error("Error fetching FX rates", e);
      }
    }

    async function getFxRate(base, target) {
      base = String(base || "").toUpperCase();
      target = String(target || "").toUpperCase();
      if (!base || !target) return null;
      if (base === target) return 1;

      if (!FX_RATES) {
        FX_RATES = { ...FX_RATES_DEFAULT };
      }

      if (!FX_RATES || !FX_RATES.USD) {
        await loadFxRates();
      }

      const rBase = parseFloat(FX_RATES[base]);
      const rTarget = parseFloat(FX_RATES[target]);
      if (!rBase || !rTarget) {
        if (!FX_ERROR_SHOWN) {
          console.error("Missing rate for", base, target, FX_RATES);
          alert("Some currency rates are missing or unavailable right now. Conversion may not work for all pairs.");
          FX_ERROR_SHOWN = true;
        }
        return null;
      }
      return rTarget / rBase;
    }

    function safeSetSelect(select, value) {
      if (!select || value == null) return;
      const target = String(value).toLowerCase();
      for (const opt of select.options) {
        if (String(opt.value).toLowerCase() === target) {
          select.value = opt.value;
          return;
        }
      }
    }

    async function loadProducts() {
      try {
        const res = await fetch(PRODUCTS_API_URL);
        const json = await res.json();
        ONLINE_PRODUCTS = json.products || [];
        fillPresetDropdown();
      } catch (err) {
        console.error("Error loading products", err);
        alert("Could not load online products. Please check your Apps Script deployment.");
        const sel = document.getElementById("product_preset");
        if (sel) {
          sel.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "-- Failed to load products --";
          sel.appendChild(opt);
        }
      }
    }

    function fillPresetDropdown() {
      const sel = document.getElementById("product_preset");
      if (!sel) return;

      sel.innerHTML = "";
      const defOpt = document.createElement("option");
      defOpt.value = "";
      defOpt.textContent = "-- Select Product Preset --";
      sel.appendChild(defOpt);

      ONLINE_PRODUCTS.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.product_key;
        opt.textContent = `${p.name || ""} ${p.power || ""} ${p.form || ""}`;
        sel.appendChild(opt);
      });

      const customOpt = document.createElement("option");
      customOpt.value = "CUSTOM";
      customOpt.textContent = "Custom (manual entry)";
      sel.appendChild(customOpt);
    }

    function toggleBrand() {
      const cb = document.getElementById("enable_brand");
      const input = document.getElementById("prod_brand");
      if (!cb || !input) return;
      input.style.display = cb.checked ? "" : "none";
      if (!cb.checked) input.value = "";
    }

    function toggleComp() {
      const cb = document.getElementById("enable_comp");
      const input = document.getElementById("prod_comp");
      if (!cb || !input) return;
      input.style.display = cb.checked ? "" : "none";
      if (!cb.checked) input.value = "";
    }

    function onPresetChange() {
      const sel = document.getElementById("product_preset");
      const key = sel.value;
      if (!key || key === "CUSTOM") return;

      const prod = ONLINE_PRODUCTS.find(p => p.product_key === key);
      if (!prod) return;

      document.getElementById("prod_name").value  = prod.name  || "";
      document.getElementById("prod_power").value = prod.power || "";

      const formSelect = document.getElementById("prod_form");
      safeSetSelect(formSelect, prod.form);

      const brandVal = prod.brand || prod.company || "";
      const compVal  = prod.composition || prod.comp || "";

      const brandCb = document.getElementById("enable_brand");
      const compCb  = document.getElementById("enable_comp");

      brandCb.checked = !!brandVal;
      document.getElementById("prod_brand").value = brandVal;
      toggleBrand();

      compCb.checked = !!compVal;
      document.getElementById("prod_comp").value = compVal;
      toggleComp();

      function setLine(lineIndex, prefix) {
        const qtyKey       = "qty" + lineIndex;
        const unitKey      = "unit" + lineIndex;
        const pillsQtyKey  = "pillsqty" + lineIndex;
        const pillsUnitKey = "pillsunit" + lineIndex;
        const priceKey     = "price" + lineIndex;

        document.getElementById(prefix + "_qty").value      = prod[qtyKey] || "";
        safeSetSelect(document.getElementById(prefix + "_unit"),      prod[unitKey]);
        document.getElementById(prefix + "_pillsqty").value = prod[pillsQtyKey] || "";
        safeSetSelect(document.getElementById(prefix + "_pillsunit"), prod[pillsUnitKey]);

        if (prod[priceKey] != null && prod[priceKey] !== "") {
          document.getElementById(prefix + "_priceamt").value = prod[priceKey];
        }
      }

      setLine(1, "l1");
      setLine(2, "l2");
      setLine(3, "l3");
    }

    function updateAltVisibility() {
      const enabled = document.getElementById("enable_alt").checked;
      document.querySelectorAll(".alt-field").forEach(div => {
        div.style.display = enabled ? "" : "none";
      });
    }

    function readLineFromForm(prefix) {
      const qty       = document.getElementById(prefix + "_qty").value.trim();
      const unit      = document.getElementById(prefix + "_unit").value.trim();
      const pillsQty  = document.getElementById(prefix + "_pillsqty").value.trim();
      const pillsUnit = document.getElementById(prefix + "_pillsunit").value.trim();
      const priceAmt  = document.getElementById(prefix + "_priceamt").value.trim();
      const priceCur  = document.getElementById(prefix + "_pricecur").value.trim();
      const altEnabled= document.getElementById("enable_alt").checked;
      let  altCur     = "";
      let  altAmt     = "";

      if (altEnabled) {
        altCur = document.getElementById(prefix + "_altcur").value.trim();
        altAmt = document.getElementById(prefix + "_altamt").value.trim();
      }

      const isEmpty = !qty && !unit && !pillsQty && !pillsUnit && !priceAmt && !priceCur && !altAmt && !altCur;
      if (isEmpty) return null;

      if (!qty || !unit || !priceAmt || !priceCur) {
        return { error: "Missing fields" };
      }

      return {
        qty,
        unit,
        pillsQty,
        pillsUnit,
        priceAmt,
        priceCur,
        altAmt,
        altCur
      };
    }

    function addProductToQuote() {
      const product = buildProductFromForm();
      if (!product) return;
      QUOTE_PRODUCTS.push(product);
      clearProductForm();
      renderQuoteProducts();
    }

    function buildProductFromForm() {
      const name  = document.getElementById("prod_name").value.trim();
      const power = document.getElementById("prod_power").value.trim();
      const form  = document.getElementById("prod_form").value.trim();

      const brandEnabled = document.getElementById("enable_brand").checked;
      const compEnabled  = document.getElementById("enable_comp").checked;
      const brand        = brandEnabled ? document.getElementById("prod_brand").value.trim() : "";
      const composition  = compEnabled  ? document.getElementById("prod_comp").value.trim() : "";

      if (!name) {
        alert("Please enter Product Name.");
        return null;
      }

      const line1 = readLineFromForm("l1");
      const line2 = readLineFromForm("l2");
      const line3 = readLineFromForm("l3");

      const lines = [];
      for (const line of [line1, line2, line3]) {
        if (!line) continue;
        if (line.error) {
          alert("Each filled line must have Qty, Unit, Price Amount and Currency.");
          return null;
        }
        lines.push(line);
      }

      if (lines.length === 0) {
        alert("Please fill at least one line with Qty, Unit, Price and Currency.");
        return null;
      }

      return {
        id: Date.now() + Math.random(),
        name,
        power,
        form,
        brand,
        composition,
        lines
      };
    }

    async function saveProductToSheet() {
      const product = buildProductFromForm();
      if (!product) return;

      // Check duplicate (same name+power+form+brand+composition)
      const newSig = [
        product.name,
        product.power,
        product.form,
        product.brand || "",
        product.composition || ""
      ].map(s => s.trim().toLowerCase()).join("|");

      const duplicate = ONLINE_PRODUCTS.some(p => {
        const sig = [
          p.name || "",
          p.power || "",
          p.form || "",
          p.brand || p.company || "",
          p.composition || p.comp || ""
        ].map(s => String(s).trim().toLowerCase()).join("|");
        return sig === newSig;
      });

      if (duplicate) {
        alert("This product already exists in the sheet (same name, power, form, brand & composition). Not saving.");
        return;
      }

      // Build payload for Apps Script
      const payload = {
        action: "saveProduct",
        name: product.name,
        power: product.power,
        form: product.form,
        brand: product.brand,
        composition: product.composition,
        lines: product.lines
      };

      try {
        const res = await fetch(PRODUCTS_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.success) {
          alert("Product saved to sheet with ID: " + json.product_key);
          // Refresh product list
          await loadProducts();
        } else {
          alert("Error saving product: " + (json.error || "Unknown error"));
        }
      } catch (e) {
        console.error("Error posting to Apps Script", e);
        alert("Error saving product. Check console for details.");
      }
    }

    function clearProductForm() {
      document.getElementById("product_preset").value = "";
      document.getElementById("prod_name").value = "";
      document.getElementById("prod_power").value = "";
      document.getElementById("prod_form").value = "Tablets";

      document.getElementById("enable_brand").checked = false;
      document.getElementById("prod_brand").value = "";
      toggleBrand();

      document.getElementById("enable_comp").checked = false;
      document.getElementById("prod_comp").value = "";
      toggleComp();

      ["l1","l2","l3"].forEach(prefix => {
        document.getElementById(prefix + "_qty").value = "";
        document.getElementById(prefix + "_unit").value = "packs";
        document.getElementById(prefix + "_pillsqty").value = "";
        document.getElementById(prefix + "_pillsunit").value = "pills";
        document.getElementById(prefix + "_priceamt").value = "";
        document.getElementById(prefix + "_pricecur").value = "USD";
        document.getElementById(prefix + "_altcur").value = "";
        document.getElementById(prefix + "_altamt").value = "";
      });
    }

    function renderQuoteProducts() {
      const container = document.getElementById("quoteProducts");
      if (!QUOTE_PRODUCTS.length) {
        container.innerHTML = "No products added yet. Fill the form above and click “Add Product to Quote”.";
        return;
      }

      let html = "";
      QUOTE_PRODUCTS.forEach((p, index) => {
        let linesText = "";

        if (p.brand) {
          linesText += "COMPANY:- " + p.brand + "\n";
        }
        if (p.composition) {
          linesText += "COMP:- " + p.composition + "\n";
        }
        if (p.brand || p.composition) {
          linesText += "\n";
        }

        p.lines.forEach(line => {
          let row = `${line.qty} ${line.unit}`;
          if (line.pillsQty || line.pillsUnit) {
            row += " (";
            if (line.pillsQty) row += line.pillsQty;
            if (line.pillsQty && line.pillsUnit) row += " ";
            if (line.pillsUnit) row += line.pillsUnit;
            row += ")";
          }
          row += `= ${line.priceAmt} ${line.priceCur}`;
          if (line.altAmt && line.altCur) {
            row += ` (${line.altAmt} ${line.altCur})`;
          }
          linesText += row + "\n";
        });

        html += `
          <div class="product-card">
            <div class="product-card-header">
              <div class="product-card-title">
                Product- ${escapeHtml(p.name)}${p.power ? " " + escapeHtml(p.power) : ""}${p.form ? " " + escapeHtml(p.form) : ""}
              </div>
              <div style="font-size:11px;color:#777;">#${index + 1}</div>
            </div>
            <div class="product-card-lines">${escapeHtml(linesText)}</div>
            <div class="product-card-buttons">
              <button type="button" onclick="editProduct(${index})">Edit</button>
              <button type="button" class="danger" onclick="removeProduct(${index})">Remove</button>
              <button type="button" onclick="moveProductUp(${index})" ${index === 0 ? "disabled" : ""}>Move Up</button>
              <button type="button" onclick="moveProductDown(${index})" ${index === QUOTE_PRODUCTS.length - 1 ? "disabled" : ""}>Move Down</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function editProduct(index) {
      const p = QUOTE_PRODUCTS[index];
      if (!p) return;

      document.getElementById("prod_name").value = p.name;
      document.getElementById("prod_power").value = p.power || "";
      document.getElementById("prod_form").value = p.form || "Tablets";
      document.getElementById("product_preset").value = "";

      const brandCb = document.getElementById("enable_brand");
      const compCb  = document.getElementById("enable_comp");

      brandCb.checked = !!p.brand;
      document.getElementById("prod_brand").value = p.brand || "";
      toggleBrand();

      compCb.checked = !!p.composition;
      document.getElementById("prod_comp").value = p.composition || "";
      toggleComp();

      const prefixes = ["l1","l2","l3"];
      prefixes.forEach((prefix, i) => {
        const line = p.lines[i];
        if (!line) {
          document.getElementById(prefix + "_qty").value = "";
          document.getElementById(prefix + "_unit").value = "packs";
          document.getElementById(prefix + "_pillsqty").value = "";
          document.getElementById(prefix + "_pillsunit").value = "pills";
          document.getElementById(prefix + "_priceamt").value = "";
          document.getElementById(prefix + "_pricecur").value = "USD";
          document.getElementById(prefix + "_altcur").value = "";
          document.getElementById(prefix + "_altamt").value = "";
        } else {
          document.getElementById(prefix + "_qty").value       = line.qty || "";
          document.getElementById(prefix + "_unit").value      = line.unit || "packs";
          document.getElementById(prefix + "_pillsqty").value  = line.pillsQty || "";
          document.getElementById(prefix + "_pillsunit").value = line.pillsUnit || "pills";
          document.getElementById(prefix + "_priceamt").value  = line.priceAmt || "";
          document.getElementById(prefix + "_pricecur").value  = line.priceCur || "USD";
          document.getElementById(prefix + "_altcur").value    = line.altCur || "";
          document.getElementById(prefix + "_altamt").value    = line.altAmt || "";
        }
      });

      QUOTE_PRODUCTS.splice(index, 1);
      renderQuoteProducts();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function removeProduct(index) {
      QUOTE_PRODUCTS.splice(index, 1);
      renderQuoteProducts();
    }

    function moveProductUp(index) {
      if (index <= 0) return;
      const tmp = QUOTE_PRODUCTS[index - 1];
      QUOTE_PRODUCTS[index - 1] = QUOTE_PRODUCTS[index];
      QUOTE_PRODUCTS[index] = tmp;
      renderQuoteProducts();
    }

    function moveProductDown(index) {
      if (index >= QUOTE_PRODUCTS.length - 1) return;
      const tmp = QUOTE_PRODUCTS[index + 1];
      QUOTE_PRODUCTS[index + 1] = QUOTE_PRODUCTS[index];
      QUOTE_PRODUCTS[index] = tmp;
      renderQuoteProducts();
    }

    function buildProductText(p) {
      let block = "";
      block += "Product- " + p.name;
      if (p.power) block += " " + p.power;
      if (p.form)  block += " " + p.form;
      block += "\n";

      if (p.brand) {
        block += "COMPANY:- " + p.brand + "\n";
      }
      if (p.composition) {
        block += "COMP:- " + p.composition + "\n";
      }
      if (p.brand || p.composition) {
        block += "\n";
      }

      p.lines.forEach(line => {
        let row = `${line.qty} ${line.unit}`;
        if (line.pillsQty || line.pillsUnit) {
          row += " (";
          if (line.pillsQty) row += line.pillsQty;
          if (line.pillsQty && line.pillsUnit) row += " ";
          if (line.pillsUnit) row += line.pillsUnit;
          row += ")";
        }
        row += `= ${line.priceAmt} ${line.priceCur}`;
        if (line.altAmt && line.altCur) {
          row += ` (${line.altAmt} ${line.altCur})`;
        }
        block += row + "\n";
      });

      block += "\n";
      return block;
    }

    function generateQuotation() {
      if (!QUOTE_PRODUCTS.length) {
        alert("Please add at least one product to the quotation.");
        return;
      }

      let text = "";
      text += "Hello,\n";
      text += "Greetings from Mediswift Medex\n\n";
      text += "We are leading exporter\n";
      text += "We got your enquiry regarding your requirement\n\n";

      QUOTE_PRODUCTS.forEach(p => {
        text += buildProductText(p);
      });

      text += "-:We will provide you 100% doorstep delivery.\n\n";
      text += "-:Discounts / offers will be applied as the quantity increases.\n\n";
      text += "-:We accept all types of payment modes.\n\n";
      text += "-:Connect with us on Whatsapp through this link - HTTPS://wa.me/919373097321\n\n";
      text += "-:Connect with us on Telegram through this link - https://t.me/Mediswift_medex\n\n";
      text += "-:Connect with us on Signal through this link- https://signal.me/#p/%2B919373097321\n\n";
      text += "Regards,\n";
      text += "Mediswift Medex\n";
      text += "Mobile - ‪+919373097321‬\n";
      text += "Website- www.mediswiftmedex.com\n";
      text += "Email id - mediswiftmedex@gmail.com\n";

      document.getElementById("output").value = text;
    }

    function copyOutput() {
      const out = document.getElementById("output");
      out.select();
      out.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("Quotation copied!");
    }

    function clearQuotation() {
      document.getElementById("output").value = "";
    }

    async function onAltCurrencyChange(prefix) {
      const altEnabled = document.getElementById("enable_alt").checked;
      if (!altEnabled) return;

      const priceAmtEl = document.getElementById(prefix + "_priceamt");
      const priceCurEl = document.getElementById(prefix + "_pricecur");
      const altCurEl   = document.getElementById(prefix + "_altcur");
      const altAmtEl   = document.getElementById(prefix + "_altamt");

      const amount = parseFloat(priceAmtEl.value);
      const baseCur = priceCurEl.value;
      const targetCur = altCurEl.value;

      if (!amount || !baseCur || !targetCur) return;

      const rate = await getFxRate(baseCur, targetCur);
      if (!rate) return;

      const converted = amount * rate;
      altAmtEl.value = String(Math.round(converted));
    }

    function onMainPriceChange(prefix) {
      const altEnabled = document.getElementById("enable_alt").checked;
      if (!altEnabled) return;
      const altCur = document.getElementById(prefix + "_altcur").value;
      if (altCur) {
        onAltCurrencyChange(prefix);
      }
    }

    window.addEventListener("load", () => {
      loadProducts();
      clearProductForm();
      updateAltVisibility();
      loadFxRates();
    });
  </script>
</body>
</html>
